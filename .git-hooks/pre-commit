#!/bin/bash

# Pre-commit hook for 42 assignments
# This hook runs norminette on all staged .c and .h files

echo "Running norminette on staged files..."

# Get list of staged .c and .h files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h)$')

if [ -z "$STAGED_FILES" ]; then
    echo "No C files to check."
    exit 0
fi

# Check if norminette is installed
if ! command -v norminette &> /dev/null; then
    echo "⚠️  Warning: norminette is not installed"
    echo "Install it with: pip install norminette"
    echo "Skipping norminette check..."
    exit 0
fi

# Run norminette on each file
ERRORS=0
for FILE in $STAGED_FILES; do
    norminette "$FILE" > /tmp/norminette_output.txt 2>&1
    
    if grep -q "Error" /tmp/norminette_output.txt; then
        echo "❌ Norminette errors in $FILE:"
        cat /tmp/norminette_output.txt
        ERRORS=$((ERRORS + 1))
    else
        echo "✅ $FILE: OK"
    fi
done

rm -f /tmp/norminette_output.txt

# If there were errors, prevent commit
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "❌ Commit rejected: Fix norminette errors before committing"
    echo "Or use 'git commit --no-verify' to skip this check"
    exit 1
fi

echo "✅ All files pass norminette!"
exit 0
