name: 42 Campus Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  norminette:
    name: Norminette Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install norminette
      run: |
        python3 -m pip install --upgrade pip
        pip install norminette
    
    - name: Run norminette on all C files
      run: |
        echo "Running norminette on all C files..."
        find . -name "*.c" -o -name "*.h" | grep -v "mini-moul" | while read file; do
          echo "Checking $file"
          norminette "$file" || echo "⚠️ Norminette failed for $file"
        done

  compile-check:
    name: Compilation Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc
    
    - name: Compile C files
      run: |
        echo "Checking C files compilation..."
        for dir in C00 C01 C02 C03 C04 C05 C06 C07 C08 C09 C10 C11 C12 C13; do
          if [ -d "$dir" ]; then
            echo "Checking $dir..."
            cd "$dir"
            for file in *.c; do
              if [ -f "$file" ] && [ "$file" != "a.out" ]; then
                echo "Compiling $file..."
                gcc -Wall -Wextra -Werror "$file" -o "${file%.c}.out" 2>&1 || echo "⚠️ Failed to compile $file"
                rm -f "${file%.c}.out"
              fi
            done
            cd ..
          fi
        done

  mini-moulinette:
    name: Mini Moulinette Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Clone mini-moulinette
      run: |
        cd ~
        git clone https://github.com/k11q/mini-moulinette.git
    
    - name: Run tests for available assignments
      run: |
        for dir in C00 C01 C02 C03 C04 C05 C06 C07 C08; do
          if [ -d "$dir" ]; then
            echo "Testing $dir..."
            cd "$dir"
            
            # Copy test files
            cp -R ~/mini-moulinette/mini-moul mini-moul 2>/dev/null || true
            
            if [ -d "mini-moul" ]; then
              cd mini-moul
              bash test.sh "$dir" || echo "⚠️ Tests failed for $dir"
              cd ..
              rm -rf mini-moul
            fi
            
            cd ..
          fi
        done
      continue-on-error: true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [norminette, compile-check, mini-moulinette]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "# 42 Campus Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All checks completed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check individual job results above for details." >> $GITHUB_STEP_SUMMARY
